#
# step V.a
# Configure remote access
# a) ssh 
# b) ipmi
#

- name: consul install
  apt:
    name: consul
    state: latest
- name: kahu-powertrain KAHU_REST_OPTIONS to listen on 0.0.0.0 
  copy:
    src: ./consul-20-agent.json
    dest:  /etc/consul.d/20-agent.json 
- name: replace retry_join ip addresses
  lineinfile:
    dest: /etc/consul.d/20-agent.json
    regexp: '\"retry_join'
    line: '"retry_join": [ {{ var_consul_retry_join }} ],'
- name: replace advertise_addr ip addresses
  lineinfile:
    dest: /etc/consul.d/20-agent.json
    regexp: '\"advertise_addr'
    line: '"advertise_addr":  {{ var_consul_advertise_addr }} ,'
- name: replace advertise_addr ip addresses
  lineinfile:
    dest: /etc/consul.d/20-agent.json
    regexp: '\"datacenter'
    line: '"datacenter":  {{ var_consul_datacenter }} ,'
- name: nginx configuration
  copy:
    src: ./nginx-config
    dest:  /etc/nginx/sites-enabled/default
